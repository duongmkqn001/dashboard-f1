<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Reschedule POs Task</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: firework 1s ease-out forwards;
        }
        
        @keyframes firework {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(20);
                opacity: 0;
            }
        }
        
        .celebration-text {
            animation: bounce 0.6s ease-in-out infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0px); }
            to { transform: translateY(-10px); }
        }
        
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Authentication Check -->
    <script>
        window.addEventListener('load', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(currentUser);
            if (user.status !== 'active') {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
                return;
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Manual Reschedule POs Task</h1>
                    <p class="text-gray-600">Complete your daily Manual Reschedule POs assignment</p>
                </div>
                <div class="text-right">
                    <div id="user-info" class="text-sm text-gray-600 mb-2"></div>
                    <div id="assignment-info" class="text-sm font-medium text-blue-600"></div>
                </div>
            </div>
        </div>

        <!-- Task Status -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Timer -->
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Time Elapsed</h3>
                    <div id="timer-display" class="timer-display text-blue-600">00:00:00</div>
                </div>
                
                <!-- Status -->
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Status</h3>
                    <div id="task-status" class="text-lg font-medium text-gray-500">Not Started</div>
                </div>
                
                <!-- Account -->
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Account</h3>
                    <div id="assigned-account" class="text-lg font-medium text-green-600">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Important Links -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-6 rounded-lg">
            <h3 class="text-lg font-semibold text-yellow-800 mb-4">üìã Important Links - Please Open These</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg border border-yellow-200">
                    <h4 class="font-semibold text-gray-800 mb-2">üìä Sheet Tracker</h4>
                    <p class="text-sm text-gray-600 mb-3">Track your progress and log data</p>
                    <a href="https://docs.google.com/spreadsheets/d/1l2-uBcdIiWhyw6mR5UArA9XW2EohDIwWs28FveqTTyw/edit?gid=1473486894#gid=1473486894" 
                       target="_blank" 
                       class="inline-block bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        üîó Open Sheet Tracker
                    </a>
                </div>
                <div class="bg-white p-4 rounded-lg border border-yellow-200">
                    <h4 class="font-semibold text-gray-800 mb-2">üõ†Ô∏è Dispatch Command Tool</h4>
                    <p class="text-sm text-gray-600 mb-3">Main tool for reschedule operations</p>
                    <a href="https://partners.wayfair.com/d/dispatch-command" 
                       target="_blank" 
                       class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        üîó Open Dispatch Tool
                    </a>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-center gap-4">
                <button id="start-btn" 
                        class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-lg text-lg font-semibold transition-colors pulse-animation">
                    ‚ñ∂Ô∏è Start Task
                </button>
                <button id="end-btn" 
                        class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-lg text-lg font-semibold transition-colors hidden">
                    ‚èπÔ∏è Complete Task
                </button>
            </div>
            <div class="text-center mt-4">
                <button id="back-to-dashboard-btn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                    üè† Back to Dashboard
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìù Instructions</h3>
            <div class="space-y-3 text-gray-600">
                <p>1. Click "Start Task" to begin timing your work</p>
                <p>2. Open both required links above in new tabs</p>
                <p>3. Use the Sheet Tracker to log your progress</p>
                <p>4. Use the Dispatch Command Tool to perform reschedule operations</p>
                <p>5. Click "Complete Task" when you're finished</p>
                <p>6. You'll be automatically returned to the dashboard</p>
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebration-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 text-center max-w-md mx-4">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-green-600 mb-4 celebration-text">Congratulations!</h2>
            <p class="text-gray-600 mb-4">You have successfully completed the Manual Reschedule POs task!</p>
            <div id="completion-time" class="text-lg font-semibold text-blue-600 mb-4"></div>
            <p class="text-sm text-gray-500">Returning to dashboard in <span id="countdown">5</span> seconds...</p>
        </div>
    </div>

    <!-- Fireworks Container -->
    <div id="fireworks-container" class="fireworks hidden"></div>

    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://pfbxtbydrjcmqlrklsdr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmYnh0YnlkcmpjbXFscmtsc2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODM2NDksImV4cCI6MjA3MjU1OTY0OX0.bOgnown0UZzstbnYfUSEImwaSGP6lg2FccRg-yDFTPU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let startTime = null;
        let timerInterval = null;
        let currentAssignment = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadAssignmentInfo();
            setupEventListeners();
        });

        async function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userInfo = document.getElementById('user-info');
            if (userInfo) {
                userInfo.textContent = `Welcome, ${currentUser.name}`;
            }
        }

        async function loadAssignmentInfo() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const today = new Date().toISOString().split('T')[0];

                // Check for assignment in the new schedule_assignments table
                const { data: assignment, error } = await supabase
                    .from('schedule_assignments')
                    .select('*')
                    .eq('agent_id', currentUser.stt)
                    .eq('assignment_date', today)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (assignment) {
                    currentAssignment = assignment;
                    document.getElementById('assigned-account').textContent = assignment.account_export_name;
                    document.getElementById('assignment-info').textContent = `Assigned: ${assignment.account_export_name}`;

                    // Update status based on assignment status
                    updateTaskStatus(assignment.status);

                    // If task was already started, resume timer
                    if (assignment.status === 'started' && assignment.started_at) {
                        startTime = new Date(assignment.started_at);
                        startTimer();
                        document.getElementById('start-btn').classList.add('hidden');
                        document.getElementById('end-btn').classList.remove('hidden');
                    }
                } else {
                    // Allow agent to work even without assignment
                    document.getElementById('assigned-account').textContent = 'No assignment for today (You can still work)';
                    document.getElementById('assignment-info').textContent = 'Working without assignment';
                    // Enable the start button anyway
                    document.getElementById('start-btn').disabled = false;
                }
            } catch (error) {
                console.error('Error loading assignment:', error);
                document.getElementById('assigned-account').textContent = 'Error loading assignment';
            }
        }

        function setupEventListeners() {
            document.getElementById('start-btn').addEventListener('click', startTask);
            document.getElementById('end-btn').addEventListener('click', endTask);
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                window.location.href = 'dashboard-v2.html';
            });
        }

        async function startTask() {
            try {
                startTime = new Date();

                // Update assignment status in database if assignment exists
                if (currentAssignment) {
                    const { error } = await supabase
                        .from('schedule_assignments')
                        .update({
                            status: 'started',
                            started_at: startTime.toISOString()
                        })
                        .eq('id', currentAssignment.id);

                    if (error) throw error;
                }

                startTimer();
                updateTaskStatus('started');

                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('end-btn').classList.remove('hidden');
            } catch (error) {
                console.error('Error starting task:', error);
                alert('Error starting task. Please try again.');
            }
        }

        async function endTask() {
            if (!startTime) return;

            try {
                const endTime = new Date();

                // Update assignment status in database if assignment exists
                if (currentAssignment) {
                    const { error } = await supabase
                        .from('schedule_assignments')
                        .update({
                            status: 'completed',
                            completed_at: endTime.toISOString()
                        })
                        .eq('id', currentAssignment.id);

                    if (error) throw error;
                }

                stopTimer();
                updateTaskStatus('completed');
                showCelebration();
            } catch (error) {
                console.error('Error ending task:', error);
                alert('Error completing task. Please try again.');
            }
        }

        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimer() {
            if (!startTime) return;

            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = timeString;
        }

        function updateTaskStatus(status) {
            const statusElement = document.getElementById('task-status');
            const statusColors = {
                'assigned': 'text-blue-600',
                'started': 'text-yellow-600',
                'completed': 'text-green-600',
                'skipped': 'text-red-600'
            };

            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.className = `text-lg font-medium ${statusColors[status] || 'text-gray-500'}`;
        }

        function showCelebration() {
            const modal = document.getElementById('celebration-modal');
            const fireworksContainer = document.getElementById('fireworks-container');
            const completionTime = document.getElementById('completion-time');
            
            // Calculate total time
            const totalTime = document.getElementById('timer-display').textContent;
            completionTime.textContent = `Total time: ${totalTime}`;
            
            // Show modal and fireworks
            modal.classList.remove('hidden');
            fireworksContainer.classList.remove('hidden');
            
            // Create fireworks
            createFireworks();
            
            // Countdown and redirect
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'dashboard-v2.html';
                }
            }, 1000);
        }

        function createFireworks() {
            const container = document.getElementById('fireworks-container');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = Math.random() * 100 + '%';
                    firework.style.top = Math.random() * 100 + '%';
                    
                    container.appendChild(firework);
                    
                    setTimeout(() => {
                        firework.remove();
                    }, 1000);
                }, i * 100);
            }
        }
    </script>
</body>
</html>
