<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Manual Schedule Notification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üß™ Manual Schedule Notification Test</h1>
            <p class="text-gray-600">Test the notification system and performance for manual schedule assignments</p>
        </div>

        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Controls</h2>
            
            <!-- Current User Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Test Agent:</label>
                <select id="agent-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Loading agents...</option>
                </select>
            </div>

            <!-- Test Account Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Test Account Name:</label>
                <input type="text" id="account-input" value="TEST_ACCOUNT_001" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter account name for testing">
            </div>

            <!-- Test Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="testFullScreenPopup()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all transform hover:scale-105">
                    üéØ Test Full-Screen Popup (8:25 AM Style)
                </button>
                <button onclick="testBannerNotification()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all transform hover:scale-105">
                    üì¢ Test Banner Notification
                </button>
                <button onclick="testActualAssignment()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all transform hover:scale-105">
                    ‚úÖ Create Test Assignment in DB
                </button>
                <button onclick="clearTestData()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition-all transform hover:scale-105">
                    üóëÔ∏è Clear Test Assignments
                </button>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Performance Metrics</h2>
            <div id="performance-metrics" class="space-y-2 text-sm">
                <p class="text-gray-600">No tests run yet...</p>
            </div>
        </div>

        <!-- Test Log -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Log</h2>
            <div id="test-log" class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs">
                <p class="text-gray-500">Waiting for tests...</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://pfbxtbydrjcmqlrklsdr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmYnh0YnlkcmpjbXFscmtsc2RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODM2NDksImV4cCI6MjA3MjU1OTY0OX0.bOgnown0UZzstbnYfUSEImwaSGP6lg2FccRg-yDFTPU';

        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            log('‚úÖ Supabase client initialized');
        } catch (error) {
            log('‚ùå Error initializing Supabase: ' + error.message, 'error');
        }

        // Load agents on page load
        window.addEventListener('load', async () => {
            await loadAgents();
        });

        async function loadAgents() {
            try {
                const { data, error } = await supabase
                    .from('vcn_agent')
                    .select('stt, name')
                    .eq('status', 'active')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('agent-select');
                select.innerHTML = '<option value="">Select an agent...</option>' +
                    data.map(agent => `<option value="${agent.stt}">${agent.name} (ID: ${agent.stt})</option>`).join('');
                
                log(`‚úÖ Loaded ${data.length} agents`);
            } catch (error) {
                log('‚ùå Error loading agents: ' + error.message, 'error');
            }
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700';
            
            const entry = document.createElement('p');
            entry.className = color;
            entry.textContent = `[${timestamp}] ${message}`;
            
            if (logDiv.firstChild?.textContent === 'Waiting for tests...') {
                logDiv.innerHTML = '';
            }
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateMetrics(metricName, value) {
            const metricsDiv = document.getElementById('performance-metrics');
            if (metricsDiv.firstChild?.textContent === 'No tests run yet...') {
                metricsDiv.innerHTML = '';
            }
            
            const metric = document.createElement('p');
            metric.className = 'text-gray-700';
            metric.innerHTML = `<strong>${metricName}:</strong> ${value}`;
            metricsDiv.appendChild(metric);
        }

        function testFullScreenPopup() {
            const startTime = performance.now();
            log('üéØ Testing full-screen popup...');
            
            const accountName = document.getElementById('account-input').value || 'TEST_ACCOUNT';
            
            const popup = document.createElement('div');
            popup.id = 'manual-schedule-popup';
            popup.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[10000]';
            popup.innerHTML = `
                <div class="bg-gradient-to-br from-orange-500 to-red-600 p-12 rounded-3xl shadow-2xl max-w-2xl text-center transform scale-100 animate-pulse-slow">
                    <div class="text-8xl mb-6">üìã</div>
                    <h1 class="text-5xl font-bold text-white mb-4">Manual Schedule Assignment</h1>
                    <p class="text-2xl text-orange-100 mb-6">You have been assigned to work on:</p>
                    <div class="bg-white bg-opacity-20 rounded-xl p-6 mb-8">
                        <p class="text-4xl font-bold text-white">${accountName}</p>
                    </div>
                    <p class="text-xl text-orange-200 mb-8">Please start your work for today!</p>
                    <button onclick="closeTestPopup()"
                            class="bg-white text-orange-600 px-8 py-4 rounded-full text-xl font-bold hover:bg-orange-50 transition-all transform hover:scale-105 shadow-lg">
                        Got it! Let's start üöÄ
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
            
            const endTime = performance.now();
            const renderTime = (endTime - startTime).toFixed(2);
            
            log(`‚úÖ Full-screen popup rendered in ${renderTime}ms`, 'success');
            updateMetrics('Popup Render Time', `${renderTime}ms`);
        }

        function testBannerNotification() {
            const startTime = performance.now();
            log('üì¢ Testing banner notification...');
            
            // Remove existing banner if any
            const existingBanner = document.getElementById('manual-reschedule-banner');
            if (existingBanner) existingBanner.remove();
            
            const accountName = document.getElementById('account-input').value || 'TEST_ACCOUNT';
            
            const banner = document.createElement('div');
            banner.id = 'manual-reschedule-banner';
            banner.className = 'bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 mb-4 rounded-lg shadow-lg border-l-4 border-orange-600 fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-2xl w-full mx-4';
            banner.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">üìã</div>
                        <div>
                            <h3 class="font-bold text-lg">Manual Schedule Assignment</h3>
                            <p class="text-orange-100">You have been assigned to work on manual schedule today.</p>
                            <p class="text-sm text-orange-200">Account: <span class="font-semibold">${accountName}</span></p>
                        </div>
                    </div>
                    <button onclick="dismissTestBanner()"
                            class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                        ‚úï
                    </button>
                </div>
            `;
            
            document.body.appendChild(banner);
            
            const endTime = performance.now();
            const renderTime = (endTime - startTime).toFixed(2);
            
            log(`‚úÖ Banner notification rendered in ${renderTime}ms`, 'success');
            updateMetrics('Banner Render Time', `${renderTime}ms`);
        }

        async function testActualAssignment() {
            const agentId = document.getElementById('agent-select').value;
            const accountName = document.getElementById('account-input').value;
            
            if (!agentId) {
                alert('Please select an agent first!');
                return;
            }
            
            if (!accountName) {
                alert('Please enter an account name!');
                return;
            }
            
            try {
                const startTime = performance.now();
                log('‚úÖ Creating test assignment in database...');
                
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('schedule_assignments')
                    .insert({
                        assignment_date: today,
                        agent_id: parseInt(agentId),
                        account_export_name: accountName,
                        assignment_type: 'manual',
                        status: 'assigned'
                    })
                    .select();
                
                if (error) throw error;
                
                const endTime = performance.now();
                const dbTime = (endTime - startTime).toFixed(2);
                
                log(`‚úÖ Test assignment created successfully in ${dbTime}ms`, 'success');
                log(`   Assignment ID: ${data[0].id}`, 'success');
                updateMetrics('DB Insert Time', `${dbTime}ms`);
                
            } catch (error) {
                log('‚ùå Error creating assignment: ' + error.message, 'error');
            }
        }

        async function clearTestData() {
            if (!confirm('Are you sure you want to clear all test assignments for today?')) {
                return;
            }
            
            try {
                log('üóëÔ∏è Clearing test assignments...');
                
                const today = new Date().toISOString().split('T')[0];
                
                const { error } = await supabase
                    .from('schedule_assignments')
                    .delete()
                    .eq('assignment_date', today)
                    .eq('assignment_type', 'manual');
                
                if (error) throw error;
                
                log('‚úÖ Test assignments cleared successfully', 'success');
                
            } catch (error) {
                log('‚ùå Error clearing assignments: ' + error.message, 'error');
            }
        }

        function closeTestPopup() {
            const popup = document.getElementById('manual-schedule-popup');
            if (popup) {
                popup.remove();
                log('‚úÖ Popup closed by user');
            }
        }

        function dismissTestBanner() {
            const banner = document.getElementById('manual-reschedule-banner');
            if (banner) {
                banner.remove();
                log('‚úÖ Banner dismissed by user');
            }
        }
    </script>
</body>
</html>

