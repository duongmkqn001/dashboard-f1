<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Parser Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">CSV Parser Test</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test CSV Parsing Functions</h2>
            <button id="test-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                Run Tests
            </button>
            <div id="test-results" class="mt-4"></div>
        </div>
    </div>

    <script>
        // Copy the CSV parsing functions from adminview.js
        function parseCsvData(csvText) {
            const lines = csvText.trim().split('\n');
            const suppliers = [];
            const children = [];
            
            if (lines.length < 2) {
                throw new Error('CSV file must contain at least a header row and one data row');
            }

            // Parse header to determine CSV format
            const header = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Expected columns for suppliers: suid, suname, (optional: other fields)
            // Expected columns for children: suchildid, parentSuid, (optional: other fields)
            
            const hasSupplierColumns = header.includes('suid') && header.includes('suname');
            const hasChildrenColumns = header.includes('suchildid') && header.includes('parentsuid');
            
            if (!hasSupplierColumns && !hasChildrenColumns) {
                throw new Error('CSV must contain either supplier columns (suid, suname) or children columns (suchildid, parentSuid)');
            }

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines
                
                const values = parseCsvLine(line);
                if (values.length !== header.length) {
                    console.warn(`Row ${i + 1} has ${values.length} columns but header has ${header.length} columns. Skipping.`);
                    continue;
                }

                const rowData = {};
                header.forEach((col, index) => {
                    rowData[col] = values[index];
                });

                // Process as supplier if it has supplier columns
                if (hasSupplierColumns && rowData.suid && rowData.suname) {
                    suppliers.push({
                        suid: rowData.suid.trim(),
                        suname: rowData.suname.trim(),
                        // Add any additional columns that exist
                        ...Object.fromEntries(
                            Object.entries(rowData).filter(([key]) => 
                                !['suid', 'suname'].includes(key) && rowData[key]
                            )
                        )
                    });
                }

                // Process as child if it has children columns
                if (hasChildrenColumns && rowData.suchildid && rowData.parentsuid) {
                    children.push({
                        suchildid: rowData.suchildid.trim(),
                        parentSuid: rowData.parentsuid.trim(),
                        // Add any additional columns that exist
                        ...Object.fromEntries(
                            Object.entries(rowData).filter(([key]) => 
                                !['suchildid', 'parentsuid'].includes(key) && rowData[key]
                            )
                        )
                    });
                }
            }

            return { suppliers, children };
        }

        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            return result;
        }

        // Test cases
        const testCases = [
            {
                name: 'Suppliers only',
                csv: `suid,suname
SUP001,Công ty ABC
SUP002,Công ty XYZ`,
                expected: { suppliers: 2, children: 0 }
            },
            {
                name: 'Children only',
                csv: `suchildid,parentSuid
CHILD001,SUP001
CHILD002,SUP001`,
                expected: { suppliers: 0, children: 2 }
            },
            {
                name: 'Mixed data',
                csv: `suid,suname,suchildid,parentSuid
SUP001,Công ty ABC,,
,,CHILD001,SUP001`,
                expected: { suppliers: 1, children: 1 }
            },
            {
                name: 'Quoted values',
                csv: `suid,suname
"SUP001","Công ty ""ABC"" Ltd"
SUP002,"Công ty XYZ"`,
                expected: { suppliers: 2, children: 0 }
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h3 class="font-semibold mb-2">Test Results:</h3>';
            
            let allPassed = true;
            
            testCases.forEach((testCase, index) => {
                try {
                    const result = parseCsvData(testCase.csv);
                    const passed = result.suppliers.length === testCase.expected.suppliers && 
                                  result.children.length === testCase.expected.children;
                    
                    if (!passed) allPassed = false;
                    
                    resultsDiv.innerHTML += `
                        <div class="p-3 mb-2 rounded ${passed ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'}">
                            <strong>${testCase.name}:</strong> ${passed ? '✅ PASSED' : '❌ FAILED'}
                            <br>Expected: ${testCase.expected.suppliers} suppliers, ${testCase.expected.children} children
                            <br>Got: ${result.suppliers.length} suppliers, ${result.children.length} children
                        </div>
                    `;
                } catch (error) {
                    allPassed = false;
                    resultsDiv.innerHTML += `
                        <div class="p-3 mb-2 rounded bg-red-100 border border-red-300">
                            <strong>${testCase.name}:</strong> ❌ ERROR
                            <br>Error: ${error.message}
                        </div>
                    `;
                }
            });
            
            resultsDiv.innerHTML += `
                <div class="p-3 mt-4 rounded ${allPassed ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'}">
                    <strong>Overall Result:</strong> ${allPassed ? '✅ All tests passed!' : '❌ Some tests failed'}
                </div>
            `;
        }

        document.getElementById('test-btn').addEventListener('click', runTests);
    </script>
</body>
</html>
